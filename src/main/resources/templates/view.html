<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title th:text="${wishlistOwner} + '\'s Wishlist'"></title>
    <link rel="stylesheet" th:href="@{/css/styles.css}" />
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
</head>
<body>
<nav class="navbar">
    <div class="navbar-left">
        <a href="/" th:href="@{/}" class="navbar-logo">Wishlist</a>
        <div class="navbar-links">
            <a class="nav-link" th:href="@{/}">Home</a>
            <a class="nav-link" th:href="@{/login}" th:if="${username == 'Guest'}">Login</a>
            <a class="nav-link" th:href="@{/signup}" th:if="${username == 'Guest'}">Signup</a>
            <ul class="nav-dropdown">
                <li class="nav-item dropdown" th:if="${username != 'Guest'}">
                    <a class="nav-link dropdown-toggle" href="#" id="wishlistDropdown" onclick="toggleDropdown(event)">
                        Wishlist <span class="arrow">&#x25BC;</span>
                    </a>
                    <div class="dropdown-menu" id="wishlistDropdownMenu">
                        <a class="dropdown-item" th:href="@{/wishlist/view}">View Wishlist</a>
                        <a class="dropdown-item" th:href="@{/wishlist/add}">Add Item</a>
                        <a class="dropdown-item" th:href="@{/wishlist/manage}">Manage Items</a>
                    </div>
                </li>
            </ul>
            <span class="nav-link" th:if="${username != 'Guest'}">
                <form action="#" th:action="@{/logout}" method="post" style="display: inline;">
                    <a href="#" onclick="event.preventDefault(); this.closest('form').submit();" class="logout-link">Logout</a>
                </form>
            </span>
        </div>
    </div>
    <span class="welcome-message" th:if="${username != 'Guest'}">Welcome, <span th:text="${username}"></span>!</span>
</nav>

<div class="container">
    <h1 th:text="${wishlistOwner} + '\'s Wishlist'"></h1>
    <div th:if="${wishListItems.isEmpty()}">
        <p>No wishlist items available.</p>
    </div>
    <div th:each="item : ${wishListItems}" class="wishlist-item" th:attr="data-item-id=${item.id}">
        <h3 th:text="${item.itemName}"></h3>
        <p th:text="${item.description}"></p>
        <p th:text="${#numbers.formatDecimal(item.price, 0, item.price % 1 == 0 ? 0 : 2) + ' kr.'}"></p>

        <button th:if="${username != wishlistOwner}" class="button"
                th:text="${item.isReserved == 1 ? 'Unreserve' : 'Reserve'}"
                th:onclick="'reserveItem(' + ${item.id} + ')'"
                th:classappend="${item.isReserved == 1 ? 'reserved' : ''}">
        </button>
    </div>

    <div class="share-button mt-3">
        <button class="btn btn-info" id="shareWishlistButton"
                th:text="${username == wishlistOwner ? 'Share My Wishlist' : 'Share Wishlist'}"></button>
    </div>
</div>

<div class="modal" id="reserveItemsModal" style="display: none;">
    <div class="modal-header">
        <h5 id="reserveItemsModalLabel">Reserve Items</h5>
        <button class="close-modal" onclick="toggleModal(false)">Close</button>
    </div>
    <div class="modal-body" id="reserveItemsModalBody">
        <p>No items to display.</p>
    </div>
    <div class="modal-footer">
        <button class="close-modal" onclick="toggleModal(false)">Close</button>
    </div>
</div>

<script>
    document.getElementById('shareWishlistButton').onclick = function() {
        const username = /*[[${username}]]*/ '';

        const urlParams = new URLSearchParams(window.location.search);
        const userParam = urlParams.get('user');

        const shareUsername = userParam && userParam.trim() !== '' ? userParam : username;

        const shareLink = `http://localhost:8080/wishlist/view?user=${shareUsername}`;

        prompt("Share this link:", shareLink);
    };

    document.getElementById('reserveItemsButton').onclick = function() {
        loadReserveItems();
    };

    function toggleDropdown(event) {
        event.preventDefault();
        const dropdownMenu = document.getElementById('wishlistDropdownMenu');
        dropdownMenu.style.display = dropdownMenu.style.display === 'block' ? 'none' : 'block';
    }

    window.onclick = function(event) {
        if (!event.target.matches('.nav-link.dropdown-toggle')) {
            const dropdowns = document.getElementsByClassName('dropdown-menu');
            for (let i = 0; i < dropdowns.length; i++) {
                dropdowns[i].style.display = 'none';
            }
        }
    }

    function reserveItem(itemId) {
        $.ajax({
            type: "POST",
            url: `/wishlist/reserve?itemId=${itemId}`,
            success: function(response) {
                const itemElement = document.querySelector(`[data-item-id='${itemId}']`);
                const statusText = itemElement.querySelector('.status-text');
                const reserveButton = itemElement.querySelector('.button');

                if (response === "Reserved") {
                    statusText.textContent = "Reserved";
                    reserveButton.textContent = "Unreserve";
                    itemElement.classList.add("reserved");
                } else if (response === "Unreserved") {
                    statusText.textContent = "Available";
                    reserveButton.textContent = "Reserve";
                    itemElement.classList.remove("reserved");
                }
            },
            error: function(xhr) {
                alert("Error: " + xhr.responseText);
            }
        });
    }
</script>

<div id="footer-placeholder"></div>

<script>
    window.onload = function() {
        fetch('../footer.html')
            .then(response => response.text())
            .then(data => {
                document.getElementById('footer-placeholder').innerHTML = data;
            })
            .catch(error => console.error('Error loading footer:', error));
    };
</script>
</body>
</html>