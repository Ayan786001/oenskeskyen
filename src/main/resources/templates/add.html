<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Add To Wishlist</title>
    <link rel="stylesheet" th:href="@{/css/styles.css}" />
</head>
<body>
<nav class="navbar">
    <div class="navbar-left">
        <a href="/" th:href="@{/}" class="navbar-logo">Wishlist</a>
        <div class="navbar-links">
            <a class="nav-link" th:href="@{/}">Home</a>
            <a class="nav-link" th:href="@{/login}" th:if="${username == 'Guest'}">Login</a>
            <a class="nav-link" th:href="@{/signup}" th:if="${username == 'Guest'}">Signup</a>
            <ul class="nav-dropdown">
                <li class="nav-item dropdown" th:if="${username != 'Guest'}">
                    <a class="nav-link dropdown-toggle" href="#" id="wishlistDropdown" onclick="toggleDropdown(event)">
                        Wishlist <span class="arrow">&#x25BC;</span>
                    </a>
                    <div class="dropdown-menu" id="wishlistDropdownMenu">
                        <a class="dropdown-item" th:href="@{/wishlist/view}">View Wishlist</a>
                        <a class="dropdown-item" th:href="@{/wishlist/add}">Add Item</a>
                        <a class="dropdown-item" th:href="@{/wishlist/manage}">Manage Items</a>
                    </div>
                </li>
            </ul>
            <span class="nav-link" th:if="${username != 'Guest'}">
                <form action="#" th:action="@{/logout}" method="post" style="display: inline;">
                    <a href="#" onclick="event.preventDefault(); this.closest('form').submit();" class="logout-link">Logout</a>
                </form>
            </span>
        </div>
    </div>
    <span class="welcome-message" th:if="${username != 'Guest'}">Welcome, <span th:text="${username}"></span>!</span>
</nav>

<div class="container">
    <div class="row">
        <div class="col-md-3 category-list">
            <ul class="list-group">
                <h4>Select Category</h4>
                <li class="category-item" th:each="category : ${categories}"
                    th:data-category-name="${category.name}" onclick="loadItemsByCategory(this)">
                    <span th:text="${category.name}"></span>
                </li>
            </ul>
        </div>

        <div class="col-md-9">
            <div id="itemList" class="row"></div>
        </div>
    </div>
</div>

<div class="modal" id="wishlistModal">
    <div class="modal-header">
        <h5 id="wishlistModalLabel">Your Order</h5>
        <button class="close-modal-one" onclick="toggleModal(false)">Close</button>
    </div>
    <div class="modal-body">
        <p id="modalMessage"></p>
        <label for="donationAmount">Donation Amount (optional):</label>
        <div class="donation-controls">
            <button class="button" onclick="changeDonationAmount(-1)">-</button>
            <input type="number" id="donationAmount" class="quantity-input" value="0" min="0" readonly>
            <button class="button" onclick="changeDonationAmount(1)">+</button>
        </div>
    </div>
    <div class="modal-footer">
        <button class="close-modal-two" onclick="toggleModal(false)">Cancel</button>
        <button class="button-two" id="confirmAdd">Confirm</button>
    </div>
</div>

<script>
    let currentItemId;

    function toggleModal(show) {
        document.getElementById("wishlistModal").style.display = show ? "block" : "none";
    }

    function loadItemsByCategory(categoryElement) {
        const categoryName = categoryElement.getAttribute("data-category-name");
        fetch(`/wishlist/items?category=${categoryName}`)
            .then(response => response.json())
            .then(items => {
                const itemList = document.getElementById('itemList');
                itemList.innerHTML = '';

                if (items.length === 0) {
                    itemList.innerHTML = '<p>No items found for this category.</p>';
                } else {
                    items.forEach(item => {
                        itemList.innerHTML += `
                        <div class="item-card">
                            <h5>${item.itemName}</h5>
                            <p>${item.description}</p>
                            <p><strong>Price:</strong> ${item.price} kr</p>
                            <div class="quantity-controls">
                                <button class="btn-decrease" onclick="changeQuantity(${item.id}, -1)">-</button>
                                <input type="number" id="quantityInput_${item.id}" class="quantity-input" value="0" min="0">
                                <button class="btn-increase" onclick="changeQuantity(${item.id}, 1)">+</button>
                            </div>
                            <button onclick="openModal(${item.id})" class="button-three">Add To Wishlist</button>
                        </div>
                    `;
                    });
                }
            })
            .catch(console.error);
    }

    function openModal(itemId) {
        currentItemId = itemId;
        document.getElementById("modalMessage").innerText = `Are you sure you want to add this item to your wishlist?`;
        document.getElementById("donationAmount").value = 0;
        toggleModal(true);
    }

    document.getElementById('confirmAdd').addEventListener('click', function () {
        const donationAmount = parseInt(document.getElementById('donationAmount').value);

        fetch(`/wishlist/add`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: `itemId=${currentItemId}&donationAmount=${donationAmount}`
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok ' + response.statusText);
                }
                return response.text();
            })
            .then(message => {
                toggleModal(false);
                showNotification(message, 'success');
            })
            .catch(error => {
                console.error("Error adding item to wishlist:", error);
                showNotification('Error adding item to wishlist.', 'danger');
            });
    });

    function changeDonationAmount(delta) {
        const donationInput = document.getElementById('donationAmount');
        let currentDonation = parseInt(donationInput.value);
        currentDonation += delta;
        if (currentDonation < 0) currentDonation = 0;
        donationInput.value = currentDonation;
    }

    function showNotification(message, type) {
        const notification = document.getElementById('notification');
        notification.className = type === 'success' ? 'alert alert-success' : 'alert alert-danger';
        notification.innerText = message;
        notification.style.display = 'block';
        setTimeout(() => {
            notification.style.display = 'none';
        }, 3000);
    }

    function toggleDropdown(event) {
        event.preventDefault();
        const dropdownMenu = document.getElementById('wishlistDropdownMenu');
        dropdownMenu.style.display = dropdownMenu.style.display === 'block' ? 'none' : 'block';
    }

    window.onclick = function(event) {
        if (!event.target.matches('.nav-link.dropdown-toggle')) {
            const dropdowns = document.getElementsByClassName('dropdown-menu');
            for (let i = 0; i < dropdowns.length; i++) {
                dropdowns[i].style.display = 'none';
            }
        }
    }

    function changeQuantity(itemId, delta) {
        const quantityInput = document.getElementById(`quantityInput_${itemId}`);
        let currentQuantity = parseInt(quantityInput.value);
        currentQuantity += delta;
        if (currentQuantity < 0) currentQuantity = 0;
        quantityInput.value = currentQuantity;
    }
</script>

<div id="footer-placeholder"></div>

<script>
    window.onload = function () {
        fetch('../footer.html')
            .then(response => response.text())
            .then(data => {
                document.getElementById('footer-placeholder').innerHTML = data;
            })
            .catch(error => console.error('Error loading footer:', error));
    };
</script>

</body>
</html>